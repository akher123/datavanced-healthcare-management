<div class="container-xl py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold mb-0 text-dark">Patient Management</h3> <p class="text-muted mb-0 small">Manage clinical database and practitioner assignments</p>
    </div>
    <button class="btn btn-primary px-4 shadow-sm" (click)="showForm = !showForm">
      <i class="bi" [class.bi-person-plus-fill]="!showForm" [class.bi-x-lg]="showForm"></i>
      {{ showForm ? ' Hide Form' : ' Add New Patient' }}
    </button>
  </div>

  <div class="input-group mb-3 shadow-sm border rounded">
    <span class="input-group-text bg-white border-0 ps-3">
      <i class="bi bi-search text-primary"></i>
    </span>
    <input type="text" class="form-control border-0 py-2" placeholder="Search by name, email, or Phone..." (input)="searchSubject.next($any($event.target).value)">
  </div>

  @if (showForm) {
  <div class="card mb-3 border-0 shadow-sm p-3 animate__animated animate__fadeIn"
       style="background-color: #f0f7ff; border-left: 4px solid #0d6efd !important;">

    <h6 class="fw-bold mb-3 text-primary border-bottom pb-2">
      <i class="bi bi-pencil-square me-2"></i>
      {{ isEditing ? 'Update Patient Information' : 'Register New Patient' }}
    </h6>

    <form [formGroup]="patientForm" (ngSubmit)="onSubmit()" class="row g-2">
      <div class="col-md-4">
        <label class="form-label fw-semibold small mb-1">First Name *</label>
        <input formControlName="firstName" class="form-control form-control-sm border-primary-subtle" [class.is-invalid]="isInvalid('firstName')">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold small mb-1">Last Name *</label>
        <input formControlName="lastName" class="form-control form-control-sm border-primary-subtle" [class.is-invalid]="isInvalid('lastName')">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold small mb-1">Date of Birth *</label>
        <input type="date" formControlName="dateOfBirth" class="form-control form-control-sm border-primary-subtle" [class.is-invalid]="isInvalid('dateOfBirth')">
      </div>
      <div class="col-md-6">
        <label class="form-label fw-semibold small mb-1">Email Address *</label>
        <input type="email" formControlName="email" class="form-control form-control-sm border-primary-subtle" [class.is-invalid]="isInvalid('email')">
      </div>
      <div class="col-md-6">
        <label class="form-label fw-semibold small mb-1">Phone Number *</label>
        <input formControlName="phone" class="form-control form-control-sm border-primary-subtle" [class.is-invalid]="isInvalid('phone')">
      </div>
      <div class="col-md-12">
        <label class="form-label fw-semibold small mb-1">Assign Caregivers</label>
        <select multiple formControlName="caregiverIds" class="form-select form-select-sm border-primary-subtle" style="min-height: 100px;">
          @for (cg of allCaregivers; track cg.caregiverId) {
          <option [value]="cg.caregiverId">ðŸ©º {{ cg.caregiverName }}</option>
          }
        </select>
      </div>
      <div class="col-12 text-end mt-3">
        <button type="button" class="btn btn-sm btn-outline-secondary px-3 me-2" (click)="cancel()">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary px-4 shadow-sm" [disabled]="patientForm.invalid">
          {{ isEditing ? 'Save Changes' : 'Create Record' }}
        </button>
      </div>
    </form>
  </div>
  }

  <div class="card border-0 shadow-sm overflow-hidden border">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead style="background-color: #eef2f7; border-bottom: 2px solid #0d6efd;">
          <tr class="small">
            <th (click)="onSort('FirstName')" class="ps-4 py-2 cursor-pointer text-primary fw-bold text-uppercase">
              Patient
              @if(request.sortBy === 'FirstName'){ <i class="bi ms-1" [class.bi-arrow-down]="request.descending" [class.bi-arrow-up]="!request.descending"></i> }
            </th>
            <th class="py-2 text-primary fw-bold text-uppercase">Contact</th>
            <th (click)="onSort('DateOfBirth')" class="py-2 text-primary fw-bold text-uppercase cursor-pointer">DOB</th>
            <th class="py-2 text-center text-primary fw-bold text-uppercase">Office</th>
            <th class="py-2 text-primary fw-bold text-uppercase">Care Team</th>
            <th class="py-2 text-center text-primary fw-bold text-uppercase">Status</th>
            <th class="text-end pe-4 py-2 text-primary fw-bold text-uppercase">Actions</th>
          </tr>
        </thead>
        <tbody style="font-size: 0.9rem;">
          @for (item of patients; track item.patientId) {
          <tr>
            <td class="ps-4 py-2">
              <div class="fw-bold text-dark">{{ item.firstName }} {{ item.lastName }}</div>
              <div class="text-muted x-small">ID: #{{ item.patientId }}</div>
            </td>
            <td class="py-2">
              <div class="small"><i class="bi bi-envelope-at text-muted me-1"></i>{{ item.email }}</div>
            </td>
            <td class="py-2 small">{{ item.dateOfBirth | date:'mediumDate' }}</td>
            <td class="text-center py-2">
              <span class="badge bg-white text-dark border px-2 py-1 fw-normal">{{ item.officeName }}</span>
            </td>
            <td class="py-2">
              <div class="d-flex flex-wrap gap-1">
                @for (cg of item.caregivers; track cg.caregiverId) {
                <span class="badge bg-info-subtle text-info border border-info-subtle px-2 py-1" style="font-size: 0.7rem;">{{ cg.caregiverName }}</span>
                }
              </div>
            </td>
            <td class="text-center py-2">
              <span class="badge rounded-pill px-2 py-1"
                    [class.bg-success-subtle]="item.isActive" [class.text-success]="item.isActive"
                    [class.bg-warning-subtle]="!item.isActive" [class.text-warning]="!item.isActive"
                    style="font-size: 0.75rem;">
                {{ item.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td class="text-end pe-4 py-2">
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary py-1 px-3" (click)="editPatient(item)">Edit</button>
                <button class="btn btn-sm btn-outline-danger py-1 px-3" (click)="deletePatient(item.patientId)">Delete</button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center py-2 px-4">
      <div class="small text-muted">Total: <b class="text-dark">{{ totalCount }}</b></div>
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-secondary px-3" [disabled]="request.pageIndex === 1" (click)="request.pageIndex = request.pageIndex - 1; loadPatients()">Prev</button>
        <span class="btn btn-sm btn-light disabled fw-bold px-3">{{ request.pageIndex }}</span>
        <button class="btn btn-sm btn-outline-secondary px-3" [disabled]="(request.pageIndex * request.pageSize) >= totalCount" (click)="request.pageIndex = request.pageIndex + 1; loadPatients()">Next</button>
      </div>
    </div>
  </div>
</div>

